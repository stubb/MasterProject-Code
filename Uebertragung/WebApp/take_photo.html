<!DOCTYPE html>
<html lang="en">
<head>
	<title>Remote control</title>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="css/themes/htw_color.css" />
	<link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" />
	<link rel="stylesheet" href="css/client.css">
	<link href="css/toastr/toastr.min.css" rel="stylesheet"/>
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script> 
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<script src="js/helper.js"></script>
	<script src="network-webrtc-adapter.js"></script>
	<script src="network-websocket-adapter.js"></script>
	<script src="network-facade.js"></script>
	<script src="js/toastr/toastr.min.js"></script>
	<script src="js/toastr/toastr_conf.js"></script>
</head>
<body>
	<script type="text/javascript">
		var nwF = new NetworkFacade("WebSocket");
		nwF.init("ws://127.0.0.1:9000", "WebAppUser");
		
		var sendFile = function() {
			var _image_data = $('#preview_canvas').get(0).toDataURL("image/png");
			_image_data = _image_data.replace(/^data:image\/png;base64,/ig, "");
		
			if (nwF.sendData(getXMLforPicture($('#preview_canvas').get(0).width, $('#preview_canvas').get(0).height, _image_data)) == 0) {
				console.log("Photo sent! Dimensions " +  $('#preview_canvas').get(0).width + " x " + $('#preview_canvas').get(0).height);
				toastr.success('Your photo was sent!');
			}
			else {
				toastr.error(result);
			}
		};
		
		window.onbeforeunload = function() {
			nwF.disconnect();
		};
		
		var video_constraints = {
			mandatory: {
				maxHeight: 480,
				maxWidth: 640 
			},
			optional: []
		};

		if (navigator.getUserMedia) {
			navigator.getUserMedia (
				// constraints
				{
					video: video_constraints,
					audio: false
				},

				// successCallback
				function(localMediaStream) {
					var video = document.querySelector('video');
					video.src = window.URL.createObjectURL(localMediaStream);
					var size = calcOptimalSize(document.getElementById('video').videoWidth, document.getElementById('video').videoHeight, $(window).width());
					video.videoWidth = size[0];
					video.videoHeight = size[1];
					video.play();
				},

				// errorCallback
				function(err) {
					console.log("The following error occured: " + err);
				}
			);
		} else {
			console.log("getUserMedia not supported");
		}

		function takepicture() {
			var canvas = document.getElementById('preview_canvas');
			var size = calcOptimalSize(document.getElementById('video').videoWidth, document.getElementById('video').videoHeight, $(window).width());
			canvas.width = size[0];
			canvas.height = size[1];
			canvas.getContext('2d').drawImage(document.getElementById('video'), 0, 0, size[0], size[1]);
			document.getElementById("sendButton").disabled = false;
		}
	</script>
  <div id="container">
	<video id="video" class="center" width="100%" height="auto"></video>
	<button onclick="takepicture()">Take photo</button>
	<button id="sendButton" onclick="sendFile()" disabled>Send</button>
	<canvas id="preview_canvas" class="center" width="100%" height="auto"></canvas>
  </div>
</body>
</html>
