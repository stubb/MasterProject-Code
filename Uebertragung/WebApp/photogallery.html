<!DOCTYPE html>
<html lang="en">
<head>
	<title>Remote control</title>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="css/themes/htw_color.css" />
	<link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" />
	<link rel="stylesheet" href="css/client.css">
	<link href="css/toastr/toastr.min.css" rel="stylesheet"/>
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script> 
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<script src="js/helper.js"></script>
	<script src="network-websocket-adapter.js"></script>
	<script src="network-facade.js"></script>
	<script src="js/toastr/toastr.min.js"></script>
	<script src="js/toastr/toastr_conf.js"></script>
</head>
<body>
	<script type="text/javascript">
		var nwF = new NetworkFacade("WebSocket");
		nwF.init("ws://127.0.0.1:9000", "WebAppUser");

		var reader = new FileReader();
		var type = null;
		var imgData = "";
		
	</script>
	<div id="content_container">
		<canvas id="preview_canvas" class="center"></canvas>
		<form>
			<input id= "filechooser" type="file" accept="image/*" autofocus onchange="loadFile(event)">
			<input type="button" onclick="sendFile()" value="Send"/>
		</form>
		<canvas id="data_canvas"></canvas>
		<script>
			var loadFile = function(event) {
				var canvas = document.getElementById('data_canvas');
				var pre_canvas = document.getElementById('preview_canvas');
				var ctx = canvas.getContext('2d');
				var ctx2 = pre_canvas.getContext("2d");
				var img = new Image();
				var image = new Image();
				type = event.target.files[0].type;
				img.src = URL.createObjectURL(event.target.files[0]);
				img.onload = function() {
					if (canvas.width > 1280) {
						canvas.width = 1280;
					}
					else {
						canvas.width = img.width;
					}
					canvas.height = img.height;
					size = resizeElement(img, 1280);
					var ctx = canvas.getContext('2d');
					ctx.drawImage(img, 0, 0, size[0], size[1]);
					imgData = canvas.toDataURL("image/png");
					image.src = imgData;
					console.log($(window).width());
					size2 = resizeElement(image, $(window).width());
					var ctx2 = pre_canvas.getContext("2d");
					ctx2.drawImage(image, 0, 0);
					pre_canvas.width = size2[0];
					pre_canvas.height = size2[1];
				}
			};
			
			var sendFile = function() {
				var time = new Date();
				var timeStr = time.toLocaleTimeString();
				var canvas = document.getElementById('preview_canvas');
				var xmlString = '<?xml version="1.0" encoding="UTF-8"?>';
				xmlString += '<package>';
				xmlString += '<type>' + type +'</type>';
				xmlString += '<width>' + canvas.width +'</width>';
				xmlString += '<height>' + canvas.height +'</height>';
				xmlString += '<timestamp>' + timeStr + '</timestamp>';
				xmlString += '<data>' + imgData + '</data>';
				xmlString += '</package>';
				result = nwF.sendData(xmlString);
				if (result == 0) {
					console.log("Photo sent!");
					toastr.success('Your photo was sent!');
				}
				else {
					toastr.error(result);
				}
			};
			
			window.onbeforeunload = function() {
				nwF.disconnect();
			};
		</script>
	</div>
</body>
</html> 
